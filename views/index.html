{% extends 'base.html' %}
{% from 'macros.html' import navbar %}

{% block main %}
{{ navbar('/', usuario) }}
<h2 class="text-center">Hello {{ usuario.name }}</h2>
<div class="container">
  <div class="row">
    <div class="col-12 col-md-4">

      <!-- formulario message -->
      <form action="/message" method="post" class="bg-white mt-1 p-4 text-black ms-5">
        <div class="mb-3 ">
          <label for="" class="form-label">Post a message</label>
          <textarea name="mensaje" id="" cols="120" rows="5" required></textarea>
        </div>
        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary fw-bold">Post a message</button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- params -->
<div class="container mt-5 bg-primary bg-opacity-25 p-4">
  {% for ms in mensajes %}
    <div class="row">
      <div class="list-group barra overflow-auto">
        <h6><b>{{ms.user_id}} </b> {{ms.date}} </h6>

        <h5><b> Likes: </b>
          <span>
            <h6 id="lkk{{ms.id}}" class="badge bg-primary rounded-pill"> {{ms.likes}}</h6>
          </span>
        </h5>

        <!-- mensaje -->
        <p><a class="list-group-item list-group-item-action">{{ms.message}}</a></p>
        
        <div class="btn-group" role="group" aria-label="Basic example">
            <form action="/like/" + {{ms.id}} method="post">
              <input type="hidden" name="like" value=`${ms.id}` class="mb-3">
              <button id="{{ms.id}}" onclick="agregarlikes(event, '{{ms.id}}')" class="btn btn-outline-primary" data-like="megusta">Like</button>
            </form>

            <!-- <button type="button" class="btn btn-outline-primary">Share</button> -->
            <button onclick="showForm('{{ms.id}}')" type="button" class="btn btn-outline-primary">Comment</button>          
            <br>
          </div>
      </div>
    </div>

    <div class="row">
      <div class="col-10 offset-1 bg-white mt-2 mb-5">
        {% for comentario in comentarios %}
        {% if comentario.message_id == ms.id %}
        <div class=" mb-2">
          <div class="row">{{comentario.user_id}} :
            <div class="col-12">
              <p>{{comentario.comment}}</p>
            </div>
          </div>
          <p class="float-end">
            <span>{{comentario.date}}</span>
            <hr>
          </p>
        </div>
        {%endif%}
        {%endfor%}
      </div>
    </div>

    <!-- formulario comment oculto -->
    <form action="/comment/{{ ms.id}}" method="post" hidden id="form_{{ ms.id }}">
      <div class="form-floating mt-2">
        <textarea class="form-control" name="comentario" id=""></textarea>
      </div>
      <div class="text-end mt-4">
        <button type="submit" class="btn btn-info">Post a comment</button>
      </div>
    </form>
  {% endfor %}
</div>
<script>
  const likes = document.querySelector("#likes");
  const template = document.querySelector("#template");

  const likesObjeto = {};

  const agregarlikes = async (ev , id) => {
    ev.preventDefault()

    console.log('id ',id);
    const h6_lk = document.getElementById(`lkk${id}`)
    
    let num_likes = parseInt(h6_lk.innerHTML)
    
    num_likes++
    h6_lk.innerHTML = num_likes
    await fetch(`/like/${id}`, {
      method: "POST",
      body: JSON.stringify({
        id,
      }),
    })

  }

  const showForm = (id) => {
    let comment = document.querySelector('#form_' + id)
    comment.removeAttribute('hidden')
  }


</script>
{% endblock %}